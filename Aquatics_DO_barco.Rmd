---
title: "Aquatucs_DO_barco"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in packages
```{r}
library(tidyverse)
library(lubridate)
library(neonstore)
library(tidybayes)
library(modelr)
library(coda)
library(daymetr)
library(tidyverse)
library(tidybayes)
library(nimble)
Sys.setenv("NEONSTORE_HOME" = "neon_store/")
if(dir.exists("neon_store/")){
  dir.create("neon_store/")
}
set.seed(329)
```

Download data
```{r}
focal_sites <- c("BARC")
neonstore::neon_download("DP1.20288.001", site =  focal_sites, type="basic") #Water Quality
neonstore::neon_download("DP1.20264.001", site =  focal_sites, type="basic") #Water Temperature
neonstore::neon_download("DP1.20053.001", site = focal_sites, type = "basic") #Surface Water Temperature
```

Load data
```{r}
oxy <- neonstore::neon_read(table = "waq_instantaneous", site = focal_sites)
temp <- neonstore::neon_read("TSD_30_min", site = focal_sites)
```


Process oxygen data to hourly.
```{r}
oxy_cleaned <- oxy %>%
  dplyr::select(siteID, startDateTime, sensorDepth, dissolvedOxygen,
                dissolvedOxygenExpUncert,dissolvedOxygenFinalQF, pH, chlorophyll, turbidity, fDOM) %>%
  dplyr::filter(dissolvedOxygenFinalQF == 0,
                sensorDepth > 0, dissolvedOxygen > 3.7, pH < 20, turbidity > 0) %>% #adding this in to drop really low values in 2018
  dplyr::mutate(startDateTime = as_datetime(startDateTime)) %>%
  dplyr::mutate(date = as_date(startDateTime),
                hour = hour(startDateTime)) %>%
  dplyr::group_by(siteID, date, hour) %>%
  dplyr::summarize(sensorDepth = mean(sensorDepth, na.rm = TRUE),
                   dissolvedOxygen = mean(dissolvedOxygen, na.rm = TRUE),
                   dissolvedOxygenExpUncert = mean(dissolvedOxygenExpUncert, na.rm = TRUE),
                   pH = mean(pH, na.rm = TRUE),
                   chlorophyll = mean(chlorophyll, na.rm = TRUE),
                   turbidity = mean(turbidity, na.rm=TRUE),
                   fDOM = mean(fDOM, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  dplyr::select(siteID, startDateTime, sensorDepth, dissolvedOxygen, dissolvedOxygenExpUncert, pH, chlorophyll, turbidity, fDOM)
```

Summarize DO and other water quality variables to daily 
```{r}
daily_data <- oxy_cleaned %>% 
  mutate(Date = as.Date(startDateTime)) %>% 
  group_by(siteID, Date) %>% 
  summarize(sensorDepth = mean(sensorDepth, na.rm = TRUE),
                   dissolvedOxygen = mean(dissolvedOxygen, na.rm = TRUE),
                   dissolvedOxygenExpUncert = mean(dissolvedOxygenExpUncert, na.rm = TRUE),
                   pH = mean(pH, na.rm = TRUE),
                   chlorophyll = mean(chlorophyll, na.rm = TRUE),
                   turbidity = mean(turbidity, na.rm=TRUE),
                   fDOM = mean(fDOM, na.rm = TRUE), .groups = "drop")
```


Visualize data + covariates (other covariates are weather, temp, etc...) The variables not plotted below are available through NEON at subdaily time scales. Additionally the meteorological varabiables can be accesed as forecasts through EFI providing 35 day NEON forecasted variables.
```{r}
daily_data %>%
  ggplot(aes(x = Date, y = dissolvedOxygen)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
daily_data %>%
  ggplot(aes(x = Date, y = pH)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
daily_data %>%
  ggplot(aes(x = Date, y = chlorophyll)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
daily_data %>%
  ggplot(aes(x = Date, y = turbidity)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
daily_data %>% #need to figure out how to QAQC
  ggplot(aes(x = Date, y = fDOM)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
```


Clean temp data, process to hourly, and select the top thermistor depth
```{r}
temp_cleaned <- temp %>%
  dplyr::select(startDateTime, siteID, tsdWaterTempMean, thermistorDepth, tsdWaterTempExpUncert) %>%
  dplyr::filter(tsdWaterTempMean > 0) %>%
  dplyr::mutate(date = as_date(startDateTime),
                hour = hour(startDateTime)) %>%
  dplyr::group_by(date, siteID, hour,thermistorDepth) %>%
  dplyr::summarize(tsdWaterTempMean = mean(tsdWaterTempMean, na.rm = TRUE),
                   tsdWaterTempExpUncert = mean(tsdWaterTempExpUncert, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour, min = 0,
                                              tz ="UTC")) %>%
  dplyr::select(startDateTime, siteID, tsdWaterTempMean,thermistorDepth,tsdWaterTempExpUncert) %>%
  dplyr::group_by(startDateTime, siteID, thermistorDepth) %>%
  dplyr::summarise(tsdWaterTempMean = mean(tsdWaterTempMean, na.rm = TRUE),
                   tsdWaterTempExpUncert = mean(tsdWaterTempExpUncert), .groups = "drop") %>% 
  dplyr::filter(thermistorDepth == min(thermistorDepth))
#new df with cleaned daily temp
daily_temp <- temp_cleaned %>% 
  mutate(Date = as.Date(startDateTime)) %>% 
  group_by(siteID, Date) %>% 
  summarize(tsdWaterTempMean = mean(tsdWaterTempMean, na.rm = TRUE),
            tsdWaterTempExpUncert = mean(tsdWaterTempExpUncert, na.rm = TRUE), .groups = "drop")
#select temp for days with DO data
daily_temp <- daily_temp[daily_temp$Date %in% daily_data$Date,]
daily_data <- daily_data[daily_data$Date %in% daily_temp$Date,]
```


Visualize daily temp data
```{r}
daily_temp %>%
  ggplot(aes(x = Date, y = tsdWaterTempMean)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
```


Model simulation - sine 
```{r}
#Model A: using a sin function and temperature to predict DO
#initialize parameters
sim_time <- length(daily_data$dissolvedOxygen)
k1 <- 7
DO <- 8
r <-0.004
k2 <- 0.04
temp <- daily_temp$tsdWaterTempMean
DO <- rep(DO, sim_time)    
for(t in 2:sim_time){
  DO[t] =  sin(DO[t - 1])*r + k1  * temp[t-1] *k2 
}
#figure out better equation to capture DO trend
#other models that do pretty well, but they are not dynamic or autocorrelated 
#Model B: using a sin fucntion to predict DO 
pred_sin <- function(x){
  y = (sin(x/7)*2.1)+7  #adjusted numbers to match scale of daily DO
}
#Model C: Just using DO from previous day to predict today's DO. 
pred_AR1 <- function(x){
    y = lag(x, 1) 
}
#Adding modeled DO to data frame 
oxy_modeled <- daily_data %>% 
  mutate(Date_numeric = as.numeric(Date),   # made a numeric date column for using the sin transform 
         modeled_DO = DO,
         sin_DO = pred_sin(Date_numeric),
         AR_DO = pred_AR1(dissolvedOxygen))
  
#Plotting comparison of observed to predicted 
plot(oxy_modeled$Date, oxy_modeled$dissolvedOxygen, main = "Model A")
lines(oxy_modeled$Date, oxy_modeled$modeled_DO, type = "l", col = "red")

plot(oxy_modeled$Date, oxy_modeled$dissolvedOxygen, main = "Model B")
lines(oxy_modeled$Date, oxy_modeled$sin_DO, type = "l", col = "red")

plot(oxy_modeled$Date, oxy_modeled$dissolvedOxygen, main = "Model C")
lines(oxy_modeled$Date, oxy_modeled$AR_DO, type = "l", col = "red")
```
Run DLM nimble model
```{r}
Tmin <- daily_temp$tsdWaterTempMean
DO <- daily_data$dissolvedOxygen

RandomWalk <- nimbleCode({
  
    #### Priors
  x[1] ~ dnorm(x_ic, sd = sd_ic)
  sd_add ~ dunif(0, 100)
  beta_0 ~ dnorm(0, 1)

  
  #### Process Model
  for(t in 2:n){
    pred[t] <- x[t-1] +  beta_0 * Tmin[t-1]
    x[t] ~ dnorm(pred[t], sd_add)
  }

  #### Data Model
  for(t in 1:n){
    y[t] ~ dnorm(x[t], sd = sd_obs)
  }

})

constants <- list(n = length(DO),
                  x_ic = log(1000),
                  sd_ic = 0.1, #daily_data$dissolvedOxygenExpUncert,
                  sd_obs = 0.1,
                  Tmin = Tmin)

data <- list(y = DO)

nchain = 3
inits <- list()
for(i in 1:nchain){
  y.samp = sample(DO, length(DO), replace = TRUE)
  inits[[i]] <- list(sd_add = sd(diff(log(y.samp))),
                     x = DO,
                     beta_0 = rnorm(1,1,0.1))
}

nimble_out <- nimbleMCMC(code = RandomWalk,
                         data = data,
                         inits = inits,
                         constants = constants,
                         monitors = c("sd_add",
                                      "x",
                                      "y"),
                         niter = 11000,
                         nchains = 3,
                         samplesAsCodaMCMC = TRUE)

## burn-in
burnin <- 1000                               
nimble_burn <- window(nimble_out, start = burnin)
plot(nimble_burn[, c("sd_add")])

chain_dlm <- nimble_burn %>%
  spread_draws(y[day],x[day],sd_add) %>% 
  mutate(y = exp(y),
         x = exp(x))

chain_dlm %>% 
  summarize(sd_add = mean(sd_add))
```

Plot modeled vs. observed DO
```{r}
DO_pred <- chain_dlm %>% group_by(day) %>% 
            summarise(mean = mean(x),
            upper = quantile(x, 0.975),
            lower = quantile(x, 0.025),.groups = "drop") %>% 
             mutate(date = daily_data$Date) 


  ggplot(data= DO_pred, aes(x = date, y = mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = "lightblue", fill = "lightblue") +
  geom_point(data = daily_data, aes(x = Date, y = dissolvedOxygen), shape=21, color="darkblue",size=2) + 
    scale_shape_identity() + labs(x = "Date", y = "DO (mg/L)", title = "Nimble DLM") 
```

