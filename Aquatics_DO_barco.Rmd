---
title: "Aquatucs_DO_barco"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in packages
```{r}
library(tidyverse)
library(lubridate)
library(neonstore)
#library(rjags)
library(tidybayes)
library(modelr)

Sys.setenv("NEONSTORE_HOME" = "neon_store/")
if(dir.exists("neon_store/")){
  dir.create("neon_store/")
}

set.seed(329)
```

Download data
```{r}
focal_sites <- c("BARC")
neonstore::neon_download("DP1.20288.001", site =  focal_sites, type="basic") #Water Quality
neonstore::neon_download("DP1.20264.001", site =  focal_sites, type="basic") #Water Temperature
neonstore::neon_download("DP1.20053.001", site = focal_sites, type = "basic") #Surface Water Temperature
```

Load data
```{r}
oxy <- neonstore::neon_read(table = "waq_instantaneous", site = focal_sites)
temp <- neonstore::neon_read("TSD_30_min", site = focal_sites)
```


Process oxygen data to hourly.
```{r}
oxy_cleaned <- oxy %>%
  dplyr::select(siteID, startDateTime, sensorDepth, dissolvedOxygen,
                dissolvedOxygenExpUncert,dissolvedOxygenFinalQF, pH, chlorophyll, turbidity, fDOM) %>%
  dplyr::filter(dissolvedOxygenFinalQF == 0,
                sensorDepth > 0, dissolvedOxygen > 3.7, pH < 20, turbidity > 0) %>% #adding this in to drop really low values in 2018
  dplyr::mutate(startDateTime = as_datetime(startDateTime)) %>%
  dplyr::mutate(date = as_date(startDateTime),
                hour = hour(startDateTime)) %>%
  dplyr::group_by(siteID, date, hour) %>%
  dplyr::summarize(sensorDepth = mean(sensorDepth, na.rm = TRUE),
                   dissolvedOxygen = mean(dissolvedOxygen, na.rm = TRUE),
                   dissolvedOxygenExpUncert = mean(dissolvedOxygenExpUncert, na.rm = TRUE),
                   pH = mean(pH, na.rm = TRUE),
                   chlorophyll = mean(chlorophyll, na.rm = TRUE),
                   turbidity = mean(turbidity, na.rm=TRUE),
                   fDOM = mean(fDOM, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour,
                                              min = 0, tz ="UTC")) %>%
  dplyr::select(siteID, startDateTime, sensorDepth, dissolvedOxygen, dissolvedOxygenExpUncert, pH, chlorophyll, turbidity, fDOM)
```

Visualize data + covariates (other covariates are weather, temp, etc...)
```{r}
oxy_cleaned %>%
  ggplot(aes(x = startDateTime, y = dissolvedOxygen)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")

oxy_cleaned %>%
  ggplot(aes(x = startDateTime, y = pH)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")

oxy_cleaned %>%
  ggplot(aes(x = startDateTime, y = chlorophyll)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")

oxy_cleaned %>%
  ggplot(aes(x = startDateTime, y = turbidity)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")

oxy_cleaned %>% #need to figure out how to QAQC
  ggplot(aes(x = startDateTime, y = fDOM)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
```

Clean temp data, process to hourly, and select the top thermistor depth
```{r}
temp_cleaned <- temp %>%
  dplyr::select(startDateTime, siteID, tsdWaterTempMean, thermistorDepth, tsdWaterTempExpUncert) %>%
  dplyr::mutate(date = as_date(startDateTime),
                hour = hour(startDateTime)) %>%
  dplyr::group_by(date, siteID, hour,thermistorDepth) %>%
  dplyr::summarize(tsdWaterTempMean = mean(tsdWaterTempMean, na.rm = TRUE),
                   tsdWaterTempExpUncert = mean(tsdWaterTempExpUncert, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(startDateTime = make_datetime(year = year(date), month = month(date),
                                              day = day(date), hour = hour, min = 0,
                                              tz ="UTC")) %>%
  dplyr::select(startDateTime, siteID, tsdWaterTempMean,thermistorDepth,tsdWaterTempExpUncert) %>%
  dplyr::group_by(startDateTime, siteID, thermistorDepth) %>%
  dplyr::summarise(tsdWaterTempMean = mean(tsdWaterTempMean, na.rm = TRUE),
                   tsdWaterTempExpUncert = mean(tsdWaterTempExpUncert), .groups = "drop") %>% 
  dplyr::filter(thermistorDepth == min(thermistorDepth))
```


Visualize temp data
```{r}
temp_cleaned %>%
  ggplot(aes(x = startDateTime, y = tsdWaterTempMean)) +
  geom_point() +
  facet_wrap(~siteID) +
  labs(x = "Date")
```


Model simulation
```{r}
#maybe sin(x)?

```
